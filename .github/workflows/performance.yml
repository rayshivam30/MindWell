name: Performance Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run performance tests daily at 3 AM UTC
    - cron: '0 3 * * *'

jobs:
  # Job 1: Backend Performance Testing
  backend-performance:
    name: Backend Performance Tests
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: Install backend dependencies
        run: cd backend && pnpm install --frozen-lockfile

      - name: Build backend
        run: cd backend && pnpm build

      - name: Start backend server
        run: |
          cd backend
          NODE_ENV=test \
          REDIS_URL=redis://localhost:6379 \
          JWT_SECRET=test-jwt-secret \
          FIREBASE_SERVICE_ACCOUNT_KEY='{"type":"service_account","project_id":"test"}' \
          node dist/server.js &
          sleep 10
        
      - name: Wait for server to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:3000/health; do sleep 1; done'

      - name: Install Artillery for load testing
        run: npm install -g artillery@latest

      - name: Run API load tests
        run: |
          cat > artillery-config.yml << EOF
          config:
            target: 'http://localhost:3000'
            phases:
              - duration: 60
                arrivalRate: 10
                name: "Warm up"
              - duration: 120
                arrivalRate: 50
                name: "Load test"
              - duration: 60
                arrivalRate: 100
                name: "Stress test"
            processor: "./artillery-processor.js"
          scenarios:
            - name: "Authentication Flow"
              weight: 40
              flow:
                - post:
                    url: "/api/auth/signup"
                    json:
                      name: "Test User {{ \$randomString() }}"
                      email: "test{{ \$randomString() }}@example.com"
                      password: "TestPassword123!"
                      confirmPassword: "TestPassword123!"
                      userType: "patient"
                - post:
                    url: "/api/auth/login"
                    json:
                      email: "{{ email }}"
                      password: "TestPassword123!"
            - name: "Health Check"
              weight: 60
              flow:
                - get:
                    url: "/health"
          EOF

          cat > artillery-processor.js << EOF
          module.exports = {
            setRandomEmail: function(requestParams, context, ee, next) {
              context.vars.email = 'test' + Math.random().toString(36).substring(7) + '@example.com';
              return next();
            }
          };
          EOF

          artillery run artillery-config.yml --output performance-report.json

      - name: Generate performance report
        run: |
          artillery report performance-report.json --output performance-report.html

      - name: Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: backend-performance-report
          path: |
            performance-report.json
            performance-report.html

      - name: Check performance thresholds
        run: |
          # Extract metrics from Artillery report
          RESPONSE_TIME_P95=$(node -e "
            const report = require('./performance-report.json');
            const summary = report.aggregate;
            console.log(summary.latency.p95);
          ")
          
          ERROR_RATE=$(node -e "
            const report = require('./performance-report.json');
            const summary = report.aggregate;
            const total = summary.counters['http.requests'] || 0;
            const errors = summary.counters['http.request_rate'] || 0;
            console.log(total > 0 ? (errors / total * 100).toFixed(2) : 0);
          ")
          
          echo "Performance Metrics:"
          echo "- 95th percentile response time: ${RESPONSE_TIME_P95}ms"
          echo "- Error rate: ${ERROR_RATE}%"
          
          # Fail if thresholds are exceeded
          if (( $(echo "$RESPONSE_TIME_P95 > 500" | bc -l) )); then
            echo "❌ Response time threshold exceeded (>500ms)"
            exit 1
          fi
          
          if (( $(echo "$ERROR_RATE > 1" | bc -l) )); then
            echo "❌ Error rate threshold exceeded (>1%)"
            exit 1
          fi
          
          echo "✅ All performance thresholds met"

  # Job 2: Frontend Performance Testing
  frontend-performance:
    name: Frontend Performance Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for web
        run: pnpm run build:web

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Serve built app
        run: |
          npx serve -s web-build -l 3000 &
          sleep 5

      - name: Run Lighthouse CI
        run: |
          lhci autorun --config=lighthouserc.json
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-reports
          path: .lighthouseci/

  # Job 3: Database Performance Testing
  database-performance:
    name: Database Performance Tests
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Redis CLI tools
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-tools

      - name: Run Redis performance tests
        run: |
          # Test Redis performance
          redis-benchmark -h localhost -p 6379 -n 10000 -c 50 -t set,get -q > redis-benchmark.txt
          cat redis-benchmark.txt

      - name: Test Redis memory usage
        run: |
          # Connect to Redis and test memory usage
          redis-cli -h localhost -p 6379 info memory

      - name: Upload database performance results
        uses: actions/upload-artifact@v3
        with:
          name: database-performance-results
          path: redis-benchmark.txt

  # Job 4: Performance Monitoring
  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    needs: [backend-performance, frontend-performance, database-performance]
    if: always()

    steps:
      - name: Download performance artifacts
        uses: actions/download-artifact@v3
        with:
          path: performance-results/

      - name: Generate performance summary
        run: |
          echo "# Performance Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Performance: ${{ needs.backend-performance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Performance: ${{ needs.frontend-performance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Database Performance: ${{ needs.database-performance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Performance Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Backend load test results available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse reports available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Database benchmark results available in artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Notify on performance degradation
        if: ${{ needs.backend-performance.result == 'failure' || needs.frontend-performance.result == 'failure' }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#performance'
          message: |
            ⚠️ *Performance Degradation Detected*
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            
            Performance tests have failed. Please review the results.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.PERFORMANCE_SLACK_WEBHOOK_URL }}